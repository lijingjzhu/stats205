---
title: 'STATS 205: Confidence Intervals'
author: "Julie Zhu"
date: "May 31, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Libraries
library(ggplot2)
library(purrr)
library(readr)
library(lubridate)
library(tidyr)
library(dplyr)
library(stringr)
library(datasets)

# Parameters
file_in <- "data/police_killings.csv"
race_file <- "clean_data/county_race.csv"
```

We first read in the files. 

```{r}
df <- read_csv(file_in)
ethnicity <- read_csv(race_file)
```

# Mental Illness

```{r}
n <- nrow(df)
alpha <- 0.05
p_1 <- sum(df$signs_of_mental_illness == "True", na.rm = TRUE)/n
p_2 <- sum(df$signs_of_mental_illness == "False", na.rm = TRUE)/n

# Change the error according 2.26
se <- sqrt((p_1 + p_2 - (p_1 - p_2)^2)/n)
error <- qnorm(1-(alpha/2))
lower_bound <- (p_1 - p_2) - error*se
upper_bound <- (p_1 - p_2) + error*se
conf_int <- c(lower_bound, upper_bound)
conf_int
```

# Body Camera

Given that you have been killed, what's the likelihood had the police had a 
body camera

```{r}
n <- nrow(df)
alpha <- 0.05
true_camera <- sum(df$body_camera == "True", na.rm = TRUE)/n
false_camera <- sum(df$body_camera == "False", na.rm = TRUE)/n
p_1 <- true_camera
p_2 <- false_camera

# Change the error according 2.26
se <- sqrt((p_1 + p_2 - (p_1 - p_2)^2)/n)
error <- qnorm(1-(alpha/2))
lower_bound <- (p_1 - p_2) - error*se
upper_bound <- (p_1 - p_2) + error*se
conf_int <- c(lower_bound, upper_bound)
conf_int
```

# Race Equality

```{r}
n <- sum(total_race$pop)
alpha <- 0.05
#p_1 <- sum(df$gender == "Male", na.rm = TRUE)/n
#p_2 <- sum(df$gender == "Female", na.rm = TRUE)/n

p_1 <- race_equal[1]
p_2 <- race_equal[2]
# Change the error according 2.26
se <- sqrt((p_1 + p_2 - (p_1 - p_2)^2)/n)
error <- qnorm(1-(alpha/2))
lower_bound <- (p_1 - p_2) - error*se
upper_bound <- (p_1 - p_2) + error*se
conf_int <- c(lower_bound, upper_bound)
conf_int

n_total <- total_race %>%
  filter(race == "Black" | race == "White") %>%
  .$pop

prop.test(race_equal[1:2]*100000, n_total)
```

```{r}
df_counts <- table(df$race) %>% as.vector

race_equal <- data_frame(race = total_race$race, 
           pop = total_race$pop,
           count = df_counts) %>%
  mutate(death_prop = count/pop) %>%
  .$death_prop

total_equal <- total_race %>%
  .$pop

  .$death_prop
prop.test()
N <- length(race_equal)
n <- nrow(df)
value <- c()
critical.range <- c()
i_val <- c()
j_val <- c()

## Compute critical values for Mascaillo Procedure
for (i in 1:(N-1)) { 
  print (i)
  for (j in (i+1):N) {
    print (j)
     value <- c(value, (abs(race_equal[i] - race_equal[j])))
     critical.range <- c(critical.range, 
                         sqrt(qchisq(.95, N - 1))
                         *sqrt(race_equal[i]*
                                 (1-race_equal[i])/n +
                                 race_equal[j]*(1-race_equal[j])/n))
     i_val <- c(i_val, i)
     j_val <- c(j_val, j)
    }
   }

round(cbind(value, critical.range, i_val, j_val), 10)
```

```{r}
p_1 <- race_equal[1]
p_2 <- race_equal[2]
n_1 <- total_equal[1]
n_2 <- total_equal[2]

p_hat <- (n_1*p_1 + n_2*p_2)/(n_1 + n_2)
z_score <- (p_1 - p_2)/(sqrt(p_hat *(1 - p_hat) * ((1/n_1) + (1/n_2))))
qnorm(0.975)
qnorm(0.025)
```

EVERYHING IS SIGNIFICANT

```{r}
yo <- data_frame(race = total_race$race, 
           pop = total_race$pop,
           count = df_counts) %>%
  mutate(data_total = nrow(df),
         total = sum(total_race$pop),
         sample_prop = count/data_total,
         total_prop = pop/total) 

t.test(yo$sample_prop, yo$total_prop)

prop.test(yo$sample_prop*nrow(df), rep(nrow(df), 6), p = yo$total_prop, correct = FALSE)

# Ethnicity

binom.test(x = yo$sample_prop[1], n = rep(nrow(df), 1), 
           p = yo$total_prop[1], 
           alternative = "less")

prop.test(yo$sample_prop[1]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[1])

binom.test(yo$sample_prop[2]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[2],
           alternative = "greater")
prop.test(yo$sample_prop[2]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[2])

binom.test(yo$sample_prop[3]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[3])
prop.test(yo$sample_prop[3]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[3])

binom.test(yo$sample_prop[4]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[4],
           alternative = "greater")

binom.test(yo$sample_prop[5]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[5],
           alternative = "less")

binom.test(yo$sample_prop[6]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[6],
           alternative = "less")
```


# Don't use the plot
# Doesn't make sense

```{r}
sample_prop <- yo$sample_prop 
total_prop <- yo$total_prop

data_frame(race = yo$race, sample = sample_prop, total = total_prop) %>%
  gather(location, prop, sample:total)  %>%
  ggplot() +
  geom_bar(mapping = aes(x = race, y = prop), color = "location",
           stat = "identity", position = "dodge")

names(sample_prop) <- c("A", "B", "H", "N", "O", "W")
names(total_prop) <- c("A", "B", "H", "N", "O", "W")

hey <- as.matrix(rbind(yo$count, yo$pop))

assoc(hey)
```

```{r}
mosaic(hey, shade = TRUE, legend = TRUE)
```

# We can use for something else

```{r}
emily <- table(df$armed, df$race) %>% as.matrix()
mosaic(emily, shade = TRUE, legend = TRUE)

fit2 <- ca(emily)

plot(fit2, dim = c(1, 2), mass = c(TRUE, TRUE), 
     contrib = "absolute", map = "rowgreen", 
     arrows = c(FALSE, TRUE))

julie <- table(df$classification, df$race)
mosaic(julie, shade = TRUE, legend = TRUE)
fit <- ca(julie)


summary(fit)

plot(fit, dim = c(1, 2), mass = c(TRUE, TRUE), 
     contrib = "absolute", map = "rowgreen", 
     arrows = c(FALSE, TRUE))
```

# Only location of where they are shot, not where they are from

```{r}
#unemployment rate
df %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = unemployment_rate))

# Educational attainment
df %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = educ_pct))

# median income
df %>%
  #distinct(race, county, med_income) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = med_income))

# percent of people below the povery line
df %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = poverty_pct))
```

```{r}
df %>%
  mutate(black_pct = black_county_pop/total_county_pop,
         white_pct = white_county_pop/total_county_pop,
         asian_pct = asian_county_pop/total_county_pop,
         hispanic_pct = hispanic_county_pop/total_county_pop) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = black_pct))
```

```{r}
df %>%
  mutate(black_pct = black_county_pop/total_county_pop,
         white_pct = white_county_pop/total_county_pop,
         asian_pct = asian_county_pop/total_county_pop,
         hispanic_pct = hispanic_county_pop/total_county_pop) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = white_pct))
```

```{r}
df %>%
  mutate(black_pct = black_county_pop/total_county_pop,
         white_pct = white_county_pop/total_county_pop,
         asian_pct = asian_county_pop/total_county_pop,
         hispanic_pct = hispanic_county_pop/total_county_pop) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = asian_pct))
```


```{r}
df %>%
  mutate(black_pct = black_county_pop/total_county_pop,
         white_pct = white_county_pop/total_county_pop,
         asian_pct = asian_county_pop/total_county_pop,
         hispanic_pct = hispanic_county_pop/total_county_pop) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = hispanic_pct))
```

```{r}
df %>%
  mutate(black_pct = black_county_pop/total_county_pop,
         white_pct = white_county_pop/total_county_pop,
         asian_pct = asian_county_pop/total_county_pop,
         hispanic_pct = hispanic_county_pop/total_county_pop,
         native_pct = native_county_pop/total_county_pop) %>%
  ggplot() +
  geom_boxplot(mapping = aes(x = race, y = native_pct))
```

# More data cleaning

```{r}
sum(is.na(df$classification))
sum(is.na(df$signs_of_mental_illness))
sum(is.na(df$date))
sum(is.na(df$race))
sum(is.na(df$age))
sum(is.na(df$educ_pct))
sum(is.na(df$unemployment_rate))
sum(is.na(df$med_income))
sum(is.na(df$flee))
sum(is.na(df$armed))
sum(is.na(df$poverty_pct))
sum(is.na(df$threat_level))
```

