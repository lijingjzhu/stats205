---
title: 'STATS 205: Pairwise Binomial Tests'
author: "Julie Zhu"
date: "June 3, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

library(mice)
md.pattern(df) %>% View()

# Mental Illness

Chi-squared test of homogeneity
is significant, not the same across all ethnicities

```{r}
mental_v_race <- df %>%
  select(race, signs_of_mental_illness) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"))

contingency_table <- t(table(mental_v_race))
contingency_table[1,]/sum(contingency_table[1,])
contingency_table[2,]/sum(contingency_table[2,])

mentalfit <- chisq.test(contingency_table)

(mentalfit$residuals)^2
```

# Classification

almost significant
```{r}
classification_v_race <- df %>%
  select(race, classification) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"),
         classification != "Other")

contingency_table <- t(table(classification_v_race))
classificationfit <- chisq.test(contingency_table)

(classificationfit$residuals)^2
```

# Body Camera

Given that you have been killed, what's the likelihood had the police had a 
body camera

Chi squared of homogeneity
not significant
```{r}
camera_v_race <- df %>%
  select(race, body_camera) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"))

contingency_table <- t(table(camera_v_race))
camerafit <- chisq.test(contingency_table)

(camerafit$residuals)^2
```

#Threatlevel

Chi-squared
significant

```{r}
threat_v_race <- df %>%
  select(race, threat_level) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"))

contingency_table <- t(table(threat_v_race))
threatfit <- chisq.test(contingency_table)

(threatfit$residuals)^2
```

# Flee

```{r}
flee_v_race <- df %>%
  select(race, flee) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"))

contingency_table <- t(table(flee_v_race))
fleefit <- chisq.test(contingency_table)

(fleefit$residuals)^2
```

# Armed
significant
```{r}
armed_v_race <- df %>%
  select(race, armed) %>%
  filter(race %in% c("Black", "Hispanic/Latino", "White"))

contingency_table <- t(table(armed_v_race))
armedfit <- chisq.test(contingency_table)

(armedfit$residuals)^2
```

# P.adjust

```{r}
p_values <- c(armedfit$p.value, mentalfit$p.value, classificationfit$p.value, fleefit$p.value, threatfit$p.value, camerafit$p.value)

# only armed is significant
p.adjust(c(armedfit$p.value, mentalfit$p.value, classificationfit$p.value, camerafit$p.value), method = "holm", n = 4) # holm method
```

# Race Equality

```{r}
df_counts <- table(df$race) %>% as.vector

race_equal <- data_frame(race = total_race$race, 
           pop = total_race$pop,
           count = df_counts) %>%
  mutate(death_prop = count/pop) %>%
  .$death_prop

total_equal <- total_race %>%
  .$pop

  .$death_prop
prop.test()
N <- length(race_equal)
n <- nrow(df)
value <- c()
critical.range <- c()
i_val <- c()
j_val <- c()

## Compute critical values for Mascaillo Procedure
for (i in 1:(N-1)) { 
  print (i)
  for (j in (i+1):N) {
    print (j)
     value <- c(value, (abs(race_equal[i] - race_equal[j])))
     critical.range <- c(critical.range, 
                         sqrt(qchisq(.95, N - 1))
                         *sqrt(race_equal[i]*
                                 (1-race_equal[i])/n +
                                 race_equal[j]*(1-race_equal[j])/n))
     i_val <- c(i_val, i)
     j_val <- c(j_val, j)
    }
   }

round(cbind(value, critical.range, i_val, j_val), 10)
```

HISPANIC IS SIGNIFICANT individiual one by one


```{r}
total_race <- read_csv("clean_data/total_race.csv")
race_props <- data_frame(race = total_race$race, 
           pop = total_race$pop,
           count = df_counts) %>%
  mutate(data_total = nrow(df),
         total = sum(total_race$pop),
         sample_prop = count/data_total,
         total_prop = pop/total) 

t.test(race_props$sample_prop, race_props$total_prop)

# Ethnicity

binom.test(x = race_props$sample_prop[1], n = rep(nrow(df), 1), 
           p = race_props$total_prop[1], 
           alternative = "less")

prop.test(race_props$sample_prop[1]*nrow(df), rep(nrow(df), 1), p = race_props$total_prop[1])

binom.test(race_props$sample_prop[2]*nrow(df), rep(nrow(df), 1), p = race_props$total_prop[2],
           alternative = "greater")
prop.test(yo$sample_prop[2]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[2])

binom.test(yo$sample_prop[3]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[3])
prop.test(yo$sample_prop[3]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[3])

binom.test(yo$sample_prop[4]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[4],
           alternative = "greater")

binom.test(yo$sample_prop[5]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[5],
           alternative = "less")

binom.test(yo$sample_prop[6]*nrow(df), rep(nrow(df), 1), p = yo$total_prop[6],
           alternative = "less")
```
